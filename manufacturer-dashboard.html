<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manufacturer Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-100 font-sans" x-data="manufacturerApp()">

    <!-- BLOCKED SCREEN -->
    <div x-show="blockedStatus" x-cloak class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center text-center p-8 text-white">
        <h1 class="text-4xl font-bold mb-2 text-red-500">ACCOUNT BLOCKED</h1>
        <p>Your manufacturer account has been suspended by Super Admin.</p>
        <button @click="auth.signOut()" class="mt-8 underline">Logout</button>
    </div>

    <!-- DASHBOARD -->
    <div x-show="!blockedStatus" class="flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <div class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-10">
            <div class="p-6 bg-slate-950 border-b border-slate-800">
                <h1 class="text-xl font-extrabold tracking-tight text-blue-500">DropNetwork</h1>
                <p class="text-[10px] text-gray-500 uppercase mt-1">Manufacturer Portal</p>
            </div>
            <div class="p-4 border-b border-slate-800 bg-slate-800/50">
                <p class="font-bold text-white truncate" x-text="profile.agencyName || 'My Company'"></p>
                <div class="flex items-center gap-1 text-yellow-400 text-xs mt-1">
                    <i class="fas fa-star"></i> <span x-text="(profile.avgRating || 0).toFixed(1)"></span> 
                    <span class="text-gray-500 ml-1" x-text="'(' + (profile.reviewCount || 0) + ')'"></span>
                </div>
            </div>
            
            <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
                <a @click="switchTab('profile')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-blue-900': tab==='profile'}"><i class="fas fa-id-card w-6 mr-2"></i> Profile <span x-show="!isBasicProfileComplete" class="text-red-400 text-xs">‚óè</span></a>
                <!-- NEW PRODUCTS TAB -->
                <a @click="switchTab('products')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-blue-900': tab==='products'}"><i class="fas fa-boxes-stacked w-6 mr-2"></i> Products</a>
                
                <a @click="switchTab('overview')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='overview'}"><i class="fas fa-globe w-6 mr-2"></i> Promo Website</a>
                <a @click="switchTab('clients')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='clients'}"><i class="fas fa-users w-6 mr-2"></i> Partners</a>
                <a @click="switchTab('orders')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='orders'}"><i class="fas fa-box w-6 mr-2"></i> Orders</a>
                <a @click="switchTab('chat')" class="flex justify-between items-center p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='chat'}">
                    <span><i class="fas fa-comments w-6 mr-2"></i> Chat</span>
                    <span x-show="unreadCount > 0" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full" x-text="unreadCount"></span>
                </a>
                <a @click="switchTab('settings')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='settings'}"><i class="fas fa-wallet w-6 mr-2"></i> Payments</a>
            </nav>
            <button @click="auth.signOut()" class="p-4 text-gray-400 hover:text-white text-sm border-t border-slate-800">Logout</button>
        </div>

        <div class="flex-1 overflow-y-auto p-8 relative">
            
            <!-- ALERTS -->
            <template x-for="alert in systemAlerts">
                <div class="mb-4 rounded p-3 text-white text-sm font-bold flex justify-between items-center shadow"
                     :class="{'bg-blue-600': alert.type === 'info', 'bg-red-600': alert.type === 'urgent'}">
                    <span x-text="alert.sender + ': ' + alert.message"></span>
                    <button @click="closeAlert(alert)" class="text-white opacity-50 hover:opacity-100">&times;</button>
                </div>
            </template>

            <!-- ======================= -->
            <!-- TAB: PRODUCTS (NEW)     -->
            <!-- ======================= -->
            <div x-show="tab==='products'">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Product Catalog</h2>
                    <button @click="openProductModal()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold shadow">
                        + Add Product
                    </button>
                </div>

                <!-- Products Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 text-gray-600 text-sm uppercase">
                            <tr>
                                <th class="p-4">Image</th>
                                <th class="p-4">Product Name</th>
                                <th class="p-4">Category</th>
                                <th class="p-4">Stock</th>
                                <th class="p-4">Price</th>
                                <th class="p-4 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            <template x-for="p in catalog">
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="p-4">
                                        <img :src="p.images[0] || 'https://via.placeholder.com/50'" class="w-12 h-12 object-cover rounded border">
                                    </td>
                                    <td class="p-4 font-bold text-gray-800" x-text="p.name"></td>
                                    <td class="p-4 text-sm text-gray-600">
                                        <span class="bg-gray-200 px-2 py-1 rounded text-xs" x-text="p.category"></span>
                                    </td>
                                    <td class="p-4">
                                        <span :class="p.stock > 0 ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100'" class="px-3 py-1 rounded-full text-xs font-bold" x-text="p.stock > 0 ? p.stock + ' In Stock' : 'Out of Stock'"></span>
                                    </td>
                                    <td class="p-4 font-bold text-blue-600" x-text="'$' + p.price"></td>
                                    <td class="p-4 text-right">
                                        <button @click="deleteProduct(p.id)" class="text-red-500 hover:text-red-700 text-sm font-bold"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="catalog.length === 0" class="p-10 text-center text-gray-400 italic">No products added yet. Start building your catalog.</div>
                </div>
            </div>

            <!-- ADD PRODUCT MODAL -->
            <div x-show="isProductModalOpen" x-cloak class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6 border-b flex justify-between items-center bg-gray-50 rounded-t-xl">
                        <h3 class="text-xl font-bold text-gray-800">Add New Product</h3>
                        <button @click="isProductModalOpen = false" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                    </div>
                    <div class="p-6 space-y-4">
                        
                        <!-- Basic Info -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Product Name *</label>
                                <input x-model="prodForm.name" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Category *</label>
                                <div class="flex gap-2">
                                    <select x-model="prodForm.category" class="flex-1 border p-2 rounded">
                                        <option value="">Select...</option>
                                        <template x-for="cat in categories"><option :value="cat" x-text="cat"></option></template>
                                    </select>
                                    <button @click="addCategory" class="bg-gray-200 px-3 rounded hover:bg-gray-300">+</button>
                                </div>
                            </div>
                        </div>

                        <!-- Price & Stock -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Price ($) *</label>
                                <input type="number" x-model="prodForm.price" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Stock Quantity *</label>
                                <input type="number" x-model="prodForm.stock" class="w-full border p-2 rounded">
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Description</label>
                            <textarea x-model="prodForm.description" rows="3" class="w-full border p-2 rounded"></textarea>
                        </div>

                        <!-- Media -->
                        <div class="border-t pt-4">
                            <h4 class="font-bold text-sm mb-3">Product Media</h4>
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                <input x-model="prodForm.images[0]" placeholder="Image URL 1" class="border p-2 rounded text-sm">
                                <input x-model="prodForm.images[1]" placeholder="Image URL 2" class="border p-2 rounded text-sm">
                                <input x-model="prodForm.images[2]" placeholder="Image URL 3" class="border p-2 rounded text-sm">
                            </div>
                            <input x-model="prodForm.videoLink" placeholder="YouTube Video Link" class="w-full border p-2 rounded text-sm">
                        </div>

                    </div>
                    <div class="p-6 border-t bg-gray-50 rounded-b-xl flex justify-end gap-3">
                        <button @click="isProductModalOpen = false" class="px-4 py-2 text-gray-600 hover:bg-gray-200 rounded">Cancel</button>
                        <button @click="saveProduct" class="px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700">Save Product</button>
                    </div>
                </div>
            </div>

            <!-- OTHER TABS (Profile, Overview, Clients, Orders, Settings) -->
            <!-- ... Keeping your existing code logic for these tabs ... -->
            
            <!-- TAB: OVERVIEW (Promo) -->
            <div x-show="tab==='overview'">
                <h2 class="text-3xl font-bold mb-6">Promotional Website</h2>
                <div x-show="isBasicProfileComplete">
                    <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                        <h3 class="font-bold text-lg mb-2">Recruitment Link</h3>
                        <div class="flex gap-2">
                            <input readonly :value="promoLink" class="w-full bg-gray-100 border p-2 rounded text-sm text-gray-600">
                            <a :href="promoLink" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">Open</a>
                        </div>
                    </div>
                </div>
                <div x-show="!isBasicProfileComplete" class="bg-gray-200 p-10 text-center rounded"><p class="font-bold">Website Locked. Complete Profile.</p></div>
            </div>

            <!-- TAB: PROFILE -->
            <div x-show="tab==='profile'">
                <h2 class="text-3xl font-bold mb-6">Profile</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded shadow border-t-4 border-blue-500">
                        <h3 class="font-bold text-lg mb-4">Basic Details</h3>
                        <div class="space-y-4">
                            <input x-model="profile.agencyName" class="w-full border p-2 rounded" placeholder="Company Name *">
                            <select x-model="profile.country" @change="updatePhoneCode" class="w-full border p-2 rounded bg-white">
                                <option value="">Select Country *</option>
                                <option value="Sri Lanka">Sri Lanka</option>
                                <option value="United States">United States</option>
                                <option value="United Kingdom">United Kingdom</option>
                                <option value="Other">Other</option>
                            </select>
                            <input x-model="profile.ownerName" class="w-full border p-2 rounded" placeholder="Owner Name">
                            <input x-model="profile.phone" class="w-full border p-2 rounded" placeholder="Phone">
                            <input x-model="profile.whatsapp" class="w-full border p-2 rounded" placeholder="WhatsApp">
                            <label class="flex gap-2 text-sm"><input type="checkbox" x-model="profile.agreedLegal"> I agree to Legal Terms</label>
                            <button @click="saveBasicProfile" class="w-full bg-blue-600 text-white font-bold py-2 rounded">Save</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: CLIENTS -->
            <div x-show="tab==='clients'">
                <h2 class="text-3xl font-bold mb-6">Partners</h2>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"><tr><th class="p-4">Name</th><th class="p-4">Phone</th><th class="p-4">Unpaid</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <template x-for="c in clients">
                                <tr class="border-t">
                                    <td class="p-4" x-text="c.fullName || c.email"></td>
                                    <td class="p-4" x-text="c.phone || '-'"></td>
                                    <td class="p-4 font-bold text-green-600" x-text="'$' + (c.unpaidEarnings||0)"></td>
                                    <td class="p-4"><button @click="markPaid(c)" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Mark Paid</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: ORDERS -->
            <div x-show="tab==='orders'">
                <h2 class="text-3xl font-bold mb-6">Orders</h2>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"><tr><th class="p-4">Date</th><th class="p-4">Customer</th><th class="p-4">Items</th><th class="p-4">Total</th></tr></thead>
                        <tbody>
                            <template x-for="o in orders">
                                <tr class="border-t">
                                    <td class="p-4 text-xs" x-text="new Date(o.date.seconds*1000).toLocaleDateString()"></td>
                                    <td class="p-4"><p class="font-bold" x-text="o.customerName"></p><p class="text-xs text-gray-500" x-text="o.customerPhone"></p></td>
                                    <td class="p-4 text-xs"><template x-for="i in o.items"><div x-text="i.name"></div></template></td>
                                    <td class="p-4 font-bold text-green-600" x-text="'$' + o.total"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="orders.length === 0" class="p-8 text-center text-gray-400">No orders.</div>
                </div>
            </div>

            <!-- TAB: CHAT -->
            <div x-show="tab==='chat'" class="h-[80vh] flex bg-white rounded shadow overflow-hidden">
                <div class="w-1/3 border-r overflow-y-auto">
                    <template x-for="c in clients"><div @click="selectChat(c)" class="p-4 border-b hover:bg-gray-50 cursor-pointer"><p class="font-bold text-sm" x-text="c.fullName || c.email"></p></div></template>
                </div>
                <div class="w-2/3 flex flex-col">
                    <div class="flex-1 overflow-y-auto p-4 space-y-3" id="msgContainer">
                        <template x-for="m in currentMessages">
                            <div class="flex" :class="m.senderId === uid ? 'justify-end' : 'justify-start'">
                                <div class="px-4 py-2 rounded-lg max-w-xs text-sm" :class="m.senderId === uid ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'"><p x-text="m.text"></p></div>
                            </div>
                        </template>
                    </div>
                    <div class="p-4 border-t flex gap-2"><input x-model="chatInput" class="flex-1 border p-2 rounded"><button @click="sendChat" class="bg-blue-600 text-white px-4 rounded">Send</button></div>
                </div>
            </div>

            <!-- TAB: SETTINGS -->
            <div x-show="tab==='settings'">
                <h2 class="text-3xl font-bold mb-6">Payment Settings</h2>
                <div class="bg-white p-6 rounded shadow max-w-lg space-y-4">
                    <input x-model="paymentData.paypal" placeholder="PayPal" class="w-full border p-2 rounded">
                    <input x-model="paymentData.stripe" placeholder="Stripe" class="w-full border p-2 rounded">
                    <textarea x-model="paymentData.bank" placeholder="Bank Details" class="w-full border p-2 rounded" rows="3"></textarea>
                    <button @click="savePayments" class="bg-slate-900 text-white px-6 py-2 rounded font-bold">Save</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        function manufacturerApp() {
            return {
                tab: 'profile', uid: null, promoLink: '',
                clients: [], clientCount: 0, systemAlerts: [], warningStatus: false, blockedStatus: false,
                plan: 'free', reviews: [], orders: [], catalog: [], categories: ['Electronics', 'Fashion', 'Home', 'Beauty'],
                
                // Forms
                profile: { agencyName: '', country: '', ownerName: '', phone: '', whatsapp: '', email: '', agreedLegal: false, theme: 'modern' },
                prodForm: { name: '', category: '', price: '', stock: '', description: '', videoLink: '', images: ['','',''] },
                
                isProductModalOpen: false,
                isBasicProfileComplete: false,
                paymentData: {}, activeChat: null, chatInput: '', currentMessages: [], unreadCount: 0,
                countryCodes: { "Sri Lanka": "+94", "United States": "+1", "United Kingdom": "+44", "Other": "" },

                init() {
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.uid = user.uid;
                            this.profile.email = user.email; 
                            this.promoLink = window.location.href.split('/').slice(0,-1).join('/') + `/manufacturer-promo.html?id=${this.uid}`;
                            this.listenData(); this.loadClients(); this.listenMessages(); this.loadOrders(); this.loadProducts();
                        } else window.location.href='index.html';
                    });
                },

                switchTab(t) { this.tab = t; if(t==='chat') this.unreadCount=0; },
                updatePhoneCode() { /* ... existing logic ... */ },

                listenData() {
                    firebase.firestore().collection('agencies').doc(this.uid).onSnapshot(doc => {
                        if(doc.exists) {
                            const data = doc.data();
                            this.warningStatus = data.warningStatus; this.blockedStatus = data.blockedStatus;
                            this.plan = data.plan || 'free';
                            if(data.paymentMethods) this.paymentData = data.paymentMethods;
                            if(data.profile) { this.profile = { ...this.profile, ...data.profile }; this.checkBasicProfile(); }
                            if(data.categories) this.categories = data.categories; // Load custom cats
                        }
                    });
                },

                // --- PRODUCT LOGIC ---
                async loadProducts() {
                    const snap = await firebase.firestore().collection('agencies').doc(this.uid).collection('master_catalog').get();
                    this.catalog = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                openProductModal() {
                    this.prodForm = { name: '', category: '', price: '', stock: '', description: '', videoLink: '', images: ['','',''] };
                    this.isProductModalOpen = true;
                },

                async addCategory() {
                    const cat = prompt("Enter new category name:");
                    if(cat && !this.categories.includes(cat)) {
                        this.categories.push(cat);
                        await firebase.firestore().collection('agencies').doc(this.uid).update({ categories: this.categories });
                    }
                },

                async saveProduct() {
                    if(!this.prodForm.name || !this.prodForm.price || !this.prodForm.stock) return alert("Fill required fields");
                    
                    const db = firebase.firestore();
                    await db.collection('agencies').doc(this.uid).collection('master_catalog').add({
                        ...this.prodForm,
                        createdAt: new Date()
                    });
                    
                    this.isProductModalOpen = false;
                    this.loadProducts();
                    alert("Product Added!");
                },

                async deleteProduct(id) {
                    if(confirm("Delete Product?")) {
                        await firebase.firestore().collection('agencies').doc(this.uid).collection('master_catalog').doc(id).delete();
                        this.loadProducts();
                    }
                },

                // --- EXISTING LOGIC ---
                checkBasicProfile() {
                    const p = this.profile;
                    if(p.agencyName && p.country && p.ownerName && p.phone && p.whatsapp && p.agreedLegal) this.isBasicProfileComplete = true;
                    else this.isBasicProfileComplete = false;
                },
                async loadOrders() {
                    const snap = await firebase.firestore().collection('orders').where('manufacturerId', '==', this.uid).orderBy('date', 'desc').get();
                    this.orders = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },
                async loadClients() {
                    const snap = await firebase.firestore().collection('users').where('parentAgency', '==', this.uid).get();
                    this.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },
                listenMessages() {
                    firebase.firestore().collection('alerts').where('target', 'in', ['all', 'agencies', this.uid]).orderBy('createdAt', 'desc').limit(5)
                      .onSnapshot(snap => { this.systemAlerts = snap.docs.map(d => d.data()); });
                },
                async saveBasicProfile() {
                    const p = this.profile;
                    if(!p.agencyName || !p.country || !p.ownerName || !p.phone) return alert("Fill fields");
                    await firebase.firestore().collection('agencies').doc(this.uid).set({ agencyName: p.agencyName, profile: this.profile }, { merge: true });
                    this.isBasicProfileComplete = true; alert("Saved!");
                },
                async savePayments() { await firebase.firestore().collection('agencies').doc(this.uid).set({ paymentMethods: this.paymentData }, { merge: true }); alert("Saved!"); },
                async markPaid(c) { if(confirm("Mark paid?")) { await firebase.firestore().collection('users').doc(c.id).update({ unpaidEarnings: 0 }); this.loadClients(); } },
                closeAlert(a) { this.systemAlerts = this.systemAlerts.filter(i => i !== a); },
                selectChat(c) {
                    this.activeChat = c;
                    firebase.firestore().collection('messages').orderBy('timestamp').onSnapshot(snap => {
                        const all = snap.docs.map(d => d.data());
                        this.currentMessages = all.filter(m => (m.senderId===this.uid && m.receiverId===c.id) || (m.senderId===c.id && m.receiverId===this.uid));
                        setTimeout(() => { document.getElementById('msgContainer').scrollTop = 9999; }, 100);
                    });
                },
                async sendChat() {
                    if(!this.chatInput) return;
                    await firebase.firestore().collection('messages').add({ senderId: this.uid, receiverId: this.activeChat.id, text: this.chatInput, timestamp: new Date() });
                    this.chatInput = '';
                }
            }
        }
    </script>
</body>
</html>
